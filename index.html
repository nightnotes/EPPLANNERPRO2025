<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Night Notes – EP Planner</title>
  <style>
*{box-sizing:border-box}body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#0b1020;color:#e9eefc}
.header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid #1f2942}
.container{max-width:1100px;margin:0 auto;padding:16px}
.card{background:#0f1630;border:1px solid #1f2942;border-radius:16px;padding:16px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
.row{display:flex;gap:10px;align-items:center}
.tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.tab{padding:10px 14px;border-radius:999px;border:1px solid #2a375d;background:#0f1630;cursor:pointer}
.tab.active{background:#1a2750}
.input,select{background:#0b132a;border:1px solid #27365e;color:#e9eefc;padding:8px 10px;border-radius:8px}
.button{background:#3357ff;color:#fff;padding:10px 14px;border:none;border-radius:10px;cursor:pointer}
.button.ghost{background:transparent;border:1px solid #2a375d}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px 8px;border-bottom:1px solid #1f2942;font-size:14px}
.badge{padding:4px 8px;border-radius:999px;border:1px solid #2a375d;font-size:12px}
.dot{width:10px;height:10px;border-radius:50%}.dot.red{background:#ef4444}.dot.green{background:#22c55e}
.footer{opacity:.6;font-size:12px;text-align:center;padding:16px}
.login{min-height:45vh;display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>
  <div id="app" class="container"></div>
  <div class="footer">© Night Notes • build: 2025-08-18 11:11:23 UTC</div>
  <script>
(()=>{
  const EMBED = {
    releases: [{"date": "2025-09-03", "artist": "Eleanor Moon", "type": "Core", "owner": "NUNEAUX", "done": false, "splits": false, "buma": false}, {"date": "2025-09-06", "artist": "Sleepy Delrow", "type": "Core", "owner": "NUNEAUX", "done": false, "splits": false, "buma": false}, {"date": "2025-09-09", "artist": "Soft Dawn", "type": "Core", "owner": "NUNEAUX", "done": false, "splits": false, "buma": false}, {"date": "2025-09-13", "artist": "Ludo Legato", "type": "Core", "owner": "ERRY", "done": false, "splits": false, "buma": false}],
    artists: [{"name": "Eleanor Moon"}, {"name": "Sleepy Delrow"}, {"name": "Soft Dawn"}, {"name": "Ludo Legato"}]
  };
  const USERS = [{name:"Martijn",password:"123!"},{name:"Nuno",password:"123!"}];
  const $=(s,c=document)=>c.querySelector(s);
  const fmt = s => new Date(s).toLocaleDateString('nl-NL',{year:'numeric',month:'2-digit',day:'2-digit'});

  const Sync = {
    useFirebase:false, db:null, status:'Offline', mod:null,
    async init(){
      try{
        // Try local stored config first
        const saved = localStorage.getItem('firebaseConfig');
        if(saved) { const cfg=JSON.parse(saved); return await this.enable(cfg); }
        // Auto-load /firebase-config.json if present
        const r = await fetch('firebase-config.json?ts='+Date.now());
        if(r.ok){
          const cfg = await r.json();
          localStorage.setItem('firebaseConfig', JSON.stringify(cfg));
          return await this.enable(cfg);
        }
      }catch(e){}
      return false;
    },
    async enable(cfg){
      try{
        const appMod = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
        const fsMod  = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
        const app = appMod.initializeApp(cfg);
        this.db = fsMod.getFirestore(app);
        this.D = fsMod.doc; this.G = fsMod.getDoc; this.S = fsMod.setDoc; this.N = fsMod.onSnapshot;
        this.useFirebase = true; this.status='Online';
        return true;
      }catch(e){ this.status='Error'; console.error(e); return false; }
    },
    async get(key, fallback){
      if(this.useFirebase && this.db){
        const ref = this.D(this.db,'night-notes',key);
        const snap = await this.G(ref);
        if(snap.exists()) return snap.data().value;
        await this.S(ref,{value:fallback}); return fallback;
      }
      try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch{ return fallback; }
    },
    async set(key,val){
      if(this.useFirebase && this.db){
        const ref = this.D(this.db,'night-notes',key);
        await this.S(ref,{value:val}); return;
      }
      localStorage.setItem(key, JSON.stringify(val));
    },
    listen(key, cb){
      if(this.useFirebase && this.db){
        const ref = this.D(this.db,'night-notes',key);
        return this.N(ref,(snap)=>{ if(snap.exists()) cb(snap.data().value); });
      }
      return ()=>{};
    }
  };

  const state = { user: JSON.parse(localStorage.getItem('user')||'null'), tab:'Releases', releases:null, artists:EMBED.artists, streams:[] };

  function header(){
    const h=document.createElement('div'); h.className='header';
    const t=document.createElement('h1'); t.textContent='Night Notes – EP Planner'; h.appendChild(t);
    const right=document.createElement('div'); right.className='row';
    const badge=document.createElement('span'); badge.className='badge'; badge.id='syncStatus'; badge.textContent='Sync: '+Sync.status; right.appendChild(badge);
    const logout=document.createElement('button'); logout.className='button ghost'; logout.textContent= state.user? 'Uitloggen':'Login';
    logout.onclick=()=>{ if(state.user){ state.user=null; localStorage.removeItem('user'); render(); } };
    right.appendChild(logout); h.appendChild(right); return h;
  }

  function tabs(curr,set){
    const w=document.createElement('div'); w.className='tabs';
    ['Releases','EP Checklist','Streams','Advertentiebeheer'].forEach(t=>{
      const b=document.createElement('button'); b.className='tab'+(t===curr?' active':''); b.textContent=t; b.onclick=()=>set(t); w.appendChild(b);
    });
    return w;
  }

  function viewLogin(){
    const box=document.createElement('div'); box.className='card login';
    box.innerHTML=`<form class="grid" style="min-width:320px;gap:12px">
      <h2 style="text-align:center;margin:0">Inloggen</h2>
      <input class="input" name="name" placeholder="Naam (Martijn/Nuno)" />
      <input class="input" name="pass" type="password" placeholder="Wachtwoord (123!)" />
      <button class="button" type="submit">Login</button>
    </form>`;
    box.querySelector('form').onsubmit=(e)=>{
      e.preventDefault();
      const n=e.target.name.value.trim(), p=e.target.pass.value;
      const ok=USERS.find(u=>u.name.toLowerCase()===n.toLowerCase() && u.password===p);
      if(!ok) return alert('Onjuiste login');
      state.user=ok.name; localStorage.setItem('user',JSON.stringify(state.user)); render();
    };
    return box;
  }

  function releasesView(){
    const card=document.createElement('div'); card.className='card';
    const top=document.createElement('div'); top.className='row'; top.style.cssText='justify-content:space-between;gap:10px;flex-wrap:wrap';
    const left=document.createElement('div'); left.className='row';
    const search=document.createElement('input'); search.className='input'; search.placeholder='Zoek op artiest';
    const only=document.createElement('input'); only.type='checkbox'; const lbl=document.createElement('label'); lbl.className='row'; lbl.textContent=' Alleen open'; lbl.prepend(only);
    left.appendChild(search); left.appendChild(lbl);
    const cnt=document.createElement('span'); cnt.className='badge'; cnt.textContent='0 releases';
    top.appendChild(left); top.appendChild(cnt); card.appendChild(top);

    const scroller=document.createElement('div'); scroller.style.cssText='overflow:auto;max-height:64vh;margin-top:8px';
    const table=document.createElement('table'); table.className='table';
    table.innerHTML='<thead><tr><th>Datum</th><th>Artiest</th><th>Type</th><th>Owner</th><th>Status</th><th>Splits</th><th>Buma/Stemra</th></tr></thead><tbody></tbody>';
    const tbody=table.querySelector('tbody'); scroller.appendChild(table); card.appendChild(scroller);

    function redraw(){
      const q=(search.value||'').toLowerCase();
      const list=state.releases
        .filter(r=>!q||(r.artist||'').toLowerCase().includes(q))
        .filter(r=>!only.checked || !r.done)
        .sort((a,b)=> new Date(a.date)-new Date(b.date));
      cnt.textContent=`${list.length} releases`;
      tbody.innerHTML='';
      list.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${fmt(r.date)}</td><td>${r.artist}</td>
          <td><span class="badge">${r.type||''}</span></td>
          <td><span class="badge">${r.owner||''}</span></td>
          <td><div class="row"><div class="dot ${r.done?'green':'red'}"></div><button class="button ghost">${r.done?'Klaar':'Open'}</button></div></td>
          <td><input type="checkbox" ${r.splits?'checked':''}></td>
          <td><input type="checkbox" ${r.buma?'checked':''}></td>`;
        tr.querySelector('button').onclick=async()=>{ r.done=!r.done; await Sync.set('releases', state.releases); redraw(); };
        const [c1,c2]=tr.querySelectorAll('input');
        c1.onchange=async e=>{ r.splits=e.target.checked; await Sync.set('releases', state.releases); };
        c2.onchange=async e=>{ r.buma=e.target.checked; await Sync.set('releases', state.releases); };
        tbody.appendChild(tr);
      });
    }
    [search,only].forEach(el=>el.addEventListener('input',redraw));
    redraw();
    return card;
  }

  function streamsView(){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML='<div class="badge">Streams demo — gedeeld via Firestore document "streams"</div>';
    return card;
  }

  function adsView(){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML='<a class="button" href="https://eppplannerpro.netlify.app/" target="_blank">Open Advertentiebeheer</a>';
    return card;
  }

  function body(){
    const app=document.getElementById('app'); app.innerHTML='';
    const nav=tabs(state.tab,(t)=>{ state.tab=t; body(); }); app.appendChild(nav);
    if(state.tab==='Releases') app.appendChild(releasesView());
    else if(state.tab==='EP Checklist') app.appendChild(document.createTextNode('Nog in ontwikkeling'));
    else if(state.tab==='Streams') app.appendChild(streamsView());
    else app.appendChild(adsView());
  }

  async function boot(){
    document.body.prepend(header());
    await Sync.init();
    $('#syncStatus').textContent='Sync: '+Sync.status;
    const saved = await Sync.get('releases', null);
    state.releases = saved || EMBED.releases;
    if(!saved) await Sync.set('releases', state.releases);
    state.streams = await Sync.get('streams', []);
    if(!state.user) document.getElementById('app').appendChild(viewLogin()); else body();
    Sync.listen('releases',(val)=>{ state.releases=val; if(state.tab==='Releases') body(); });
    Sync.listen('streams',(val)=>{ state.streams=val; if(state.tab==='Streams') body(); });
  }
  boot();
})();
</script>
</body>
</html>
